{% extends "base.html" %}
{% load static %}
{% load video_extras %}
{% block content %}

    <main>
      <!-- Page header -->
      <!-- Page header -->
      <section class="pt-lg-8 pb-8 bg-primary">
        <div class="container pb-lg-8">
          <div class="row align-items-center">
            <div class="col-xl-7 col-lg-7 col-md-12">
              <div>
                <h1 class="text-white display-4 fw-semibold">
                  {{ course.turkish_name|default:course.english_name }}
                </h1>
                <p class="text-white mb-6 lead">{{ course.description }}</p>
                <div class="d-flex align-items-center">

                  <a href="{% url 'dashboard_student' %}" class="btn btn-outline-light btn-lg d-inline-flex align-items-center">
                    <i class="fe fe-arrow-left me-2 fs-5"></i>
                    Back to Dashboard
                  </a>
                  <span class="text-white ms-3">
                    <i class="fe fe-user"></i>
                    {{ course.enrollment_set.count }} Enrolled
                  </span>

                  <div>
                    <span class="fs-6 ms-4 align-text-top">
                      {% for i in "12345" %}
                        <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" fill="currentColor"
                             class="bi bi-star-fill text-warning" viewBox="0 0 16 16">
                          <path
                            d="M3.612 15.443c-.386.198-.824-.149-.746-.592l.83-4.73L.173 6.765c-.329-.314-.158-.888.283-.95l4.898-.696L7.538.792c.197-.39.73-.39.927 0l2.184 4.327 4.898.696c.441.062.612.636.282.95l-3.522 3.356.83 4.73c.078.443-.36.79-.746.592L8 13.187l-4.389 2.256z"/>
                        </svg>
                      {% endfor %}
                    </span>
                    <span class="text-white">({{ course.score }})</span>
                  </div>

                  <span class="text-white ms-4 d-none d-md-block">
                    <svg width="16" height="16" viewBox="0 0 16 16" fill="none"
                         xmlns="http://www.w3.org/2000/svg">
                      <rect x="3" y="8" width="2" height="6" rx="1" fill="#DBD8E9"></rect>
                      <rect x="7" y="5" width="2" height="9" rx="1" fill="#DBD8E9"></rect>
                      <rect x="11" y="2" width="2" height="12" rx="1" fill="#DBD8E9"></rect>
                    </svg>
                    <span class="align-middle">{{ course.difficulty }}</span>
                  </span>

                </div>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- Page content -->
      <section class="pb-8">
        <div class="container">
          <div class="row">
            <div class="col-lg-8 col-md-12 col-12 mt-n8 mb-4 mb-lg-0">
              <!-- Card -->
              <div class="card rounded-3">
                <!-- Card header -->
                <div class="card-header border-bottom-0 p-0">
                  <div>
                    <!-- Nav -->
                    <ul class="nav nav-lb-tab" id="tab" role="tablist">
                      <li class="nav-item">
                        <a class="nav-link active" id="table-tab" data-bs-toggle="pill" href="#table" role="tab" aria-controls="table" aria-selected="true">Contents</a>
                      </li>
                      <li class="nav-item">
                        <a class="nav-link" id="description-tab" data-bs-toggle="pill" href="#description" role="tab" aria-controls="description" aria-selected="false">Description</a>
                      </li>
                      <li class="nav-item">
                        <a class="nav-link" id="faq-tab" data-bs-toggle="pill" href="#faq" role="tab" aria-controls="faq" aria-selected="false">FAQ</a>
                      </li>
                    </ul>
                  </div>
                </div>
                <!-- Card Body -->
                <div class="card-body">
                  <div class="tab-content" id="tabContent">
                    <div class="tab-pane fade show active" id="table" role="tabpanel" aria-labelledby="table-tab">
                      <!-- Card -->
                      <div class="accordion" id="courseAccordion">
                        <div>
                          <ul class="list-group list-group-flush">
                            {% for section in sections %}
                              <li class="list-group-item px-0 {% if forloop.first %}pt-0{% endif %}">
                                <!-- Toggle -->
                                <a class="h4 mb-0 d-flex align-items-center {% if forloop.first %}active{% endif %}"
                                   data-bs-toggle="collapse"
                                   href="#section{{ section.id }}"
                                   aria-expanded="{% if forloop.first %}true{% else %}false{% endif %}"
                                   aria-controls="section{{ section.id }}">
                                  <div class="me-auto">{{ section.big_title|default:"Untitled Section" }}</div>
                                  <!-- Chevron -->
                                  <span class="chevron-arrow ms-4">
                                    <i class="fe fe-chevron-down fs-4"></i>
                                  </span>
                                </a>

                                <!-- Collapse -->
                                <div class="collapse {% if forloop.first %}show{% endif %}" id="section{{ section.id }}" data-bs-parent="#courseAccordion">
                                  <div class="pt-3 pb-2">
                                    {% for sub in section.subsections.all %}
                                      <a href="#" class="mb-2 d-flex justify-content-between align-items-center text-inherit"
                                         data-bs-toggle="modal"
                                         data-bs-target="#videoModal{{ sub.id }}">
                                        <div class="text-truncate">
                                          <span class="icon-shape bg-light icon-sm rounded-circle me-2">
                                            <i class="fe fe-play fs-6"></i>
                                          </span>
                                          <span>{{ sub.small_title|default:"Untitled Video" }}</span>
                                        </div>
                                        <div class="text-truncate">
                                          <span>{{ sub.duration|default:"0:00" }}</span>
                                        </div>
                                      </a>

                                      <!-- Video Modal -->
                                      <div class="modal fade" id="videoModal{{ sub.id }}" tabindex="-1" aria-labelledby="videoModalLabel{{ sub.id }}" aria-hidden="true">
                                        <div class="modal-dialog modal-xl modal-dialog-centered">
                                          <div class="modal-content">
                                            <div class="modal-header">
                                              <h5 class="modal-title" id="videoModalLabel{{ sub.id }}">{{ sub.small_title }}</h5>
                                              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                            </div>
                                            <div class="modal-body p-0">
                                              {% with yt=sub.video_url|youtube_embed %}
                                                {% if yt %}
                                                  <div style="aspect-ratio: 16/9; width: 100%; max-width: 960px; margin: 0 auto;">
                                                    <iframe
                                                      src="{{ yt }}{% if '?' in yt %}&{% else %}?{% endif %}autoplay=1&mute=1&rel=0&modestbranding=1"
                                                      title="{{ sub.small_title }}"
                                                      allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
                                                      allowfullscreen
                                                      style="width: 100%; height: 100%; border: 0;"
                                                    ></iframe>
                                                  </div>
                                                {% else %}
                                                  <div class="text-center py-5">
                                                    <p class="text-muted">No video available for this subsection.</p>
                                                  </div>
                                                {% endif %}
                                              {% endwith %}
                                            </div>

                                          </div>
                                        </div>
                                      </div>
                                    {% endfor %}

                                  </div>
                                </div>
                              </li>
                            {% endfor %}
                          </ul>
                        </div>
                      </div>
                    </div>
                    <div class="tab-pane fade" id="description" role="tabpanel" aria-labelledby="description-tab">
                      <!-- Description -->
                      <div class="mb-4">
                        <h3 class="mb-2">Course Descriptions</h3>
                        <p>{{ course.description|linebreaks }}</p>
                      </div>
                      <div class="mb-4">
                        <h3 class="mb-2">Attachments</h3>

                        {% if course.attachment %}
                        <a href="{{ course.attachment }}" download class="btn btn-sm btn-outline-success mt-3">
                          ⬇️ Download PDF
                        </a>
                      {% else %}
                        <p class="text-muted">No attachment uploaded.</p>
                      {% endif %}

                      </div>

                    </div>
                    <div class="tab-pane fade" id="faq" role="tabpanel" aria-labelledby="faq-tab">
                      <!-- FAQ -->
                      <div>
                        <h3 class="mb-3">Course - Frequently Asked Questions</h3>
                        {% for faq in faqs %}
                          <div class="mb-4">
                            <h4>{{ faq.question }}</h4>
                            <p>{{ faq.answer }}</p>
                          </div>
                        {% empty %}
                          <p>No frequently asked questions available for this course.</p>
                        {% endfor %}
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <div class="col-lg-4 col-md-12 col-12 mt-lg-n8">
              <!-- Card -->
              <div class="card mb-3 mb-4">
                <div class="p-1">
                  <div
                    class="d-flex justify-content-center align-items-center rounded border-white border rounded-3 bg-cover"
                    style="background-image: url('{{ course.image.url }}'); height: 210px">
                    {% if first_video_sub %}
                      <a href="#" class="icon-shape rounded-circle btn-play icon-xl"
                         data-bs-toggle="modal" data-bs-target="#previewModal">
                        <i class="fe fe-play"></i>
                      </a>
                    {% endif %}
                  </div>
                </div>

                <!-- Card body -->
                <div class="card-body">
                  <!-- Course Title -->
                  <h3 class="mb-3">{{ course.turkish_name|default:course.english_name }}</h3>
                </div>
              </div>

              <!-- Card -->
              <div class="card mb-4">
                <div>
                  <!-- Card header -->
                  <div class="card-header">
                    <h4 class="mb-0">What’s included</h4>
                  </div>
                  <ul class="list-group list-group-flush">
                    <li class="list-group-item bg-transparent">
                      <i class="fe fe-shield align-middle me-2 text-primary"></i>
                      Real-world IT Audit, Control, and GRC Exercises
                    </li>
                    <li class="list-group-item bg-transparent">
                      <i class="fe fe-edit-3 me-2 align-middle text-success"></i>
                      Interactive Quizzes for Every Module
                    </li>
                    <li class="list-group-item bg-transparent">
                      <i class="fe fe-message-square align-middle me-2 text-info"></i>
                      Personalized Feedback After Submissions
                    </li>
                    <li class="list-group-item bg-transparent">
                      <i class="fe fe-book-open align-middle me-2 text-secondary"></i>
                      Exam Preparation for CISA, CISM, CISSP
                    </li>
                    <li class="list-group-item bg-transparent">
                      <i class="fe fe-zap align-middle me-2 text-warning"></i>
                      Lifetime Access to All Updates
                    </li>
                  </ul>
                </div>
              </div>

            </div>
          </div>
        </div>
      </section>

      <!-- Video Preview Modal -->
      <div class="modal fade" id="previewModal" tabindex="-1" aria-labelledby="previewModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-xl">
          <div class="modal-content">
            <div class="modal-body p-0">
              {% with yt=first_video_sub.video_url|youtube_embed %}
                {% if yt %}
                <div style="aspect-ratio: 16/9; width: 100%; max-width: 960px; margin: 0 auto;">
                  <iframe
                    src="{{ yt }}{% if '?' in yt %}&{% else %}?{% endif %}autoplay=1&mute=1&rel=0&modestbranding=1"
                    allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
                    allowfullscreen
                    style="width: 100%; height: 100%; border: 0;"
                  ></iframe>
                </div>

                {% else %}
                  <div class="text-center py-5">
                    <p class="text-muted">No video available.</p>
                  </div>
                {% endif %}
              {% endwith %}
            </div>
          </div>
        </div>
      </div>


    </main>
{% endblock %}
